import{s as n}from"./supabase.Bouij7RW.js";import"./_commonjsHelpers.gnU0ypJ3.js";import"./preload-helper.BlTxHScW.js";const c=async()=>{try{console.log("Iniciando callback de autenticación..."),console.log("URL actual:",window.location.href);const{data:e,error:s}=await n.auth.getSession();if(s)throw console.error("Error obteniendo sesión:",s),s;if(console.log("Datos de sesión obtenidos:",e),!e.session){console.error("No hay sesión activa");const r=new URLSearchParams(window.location.search),o=r.get("error"),t=r.get("error_description");o?(console.error("Error de OAuth:",o,t),alert(`Error de autenticación: ${o} - ${t}`)):alert("No se pudo completar la autenticación. Por favor intenta de nuevo."),window.location.href="/";return}const a=e.session;if(console.log("Sesión encontrada:",a),console.log("Provider:",a.provider_refresh_token?"Discord":"Otro"),a.provider_token&&a.provider_refresh_token)try{console.log("Obteniendo datos de Discord...");const r=await fetch("https://discord.com/api/users/@me",{headers:{Authorization:`Bearer ${a.provider_token}`}});if(!r.ok)console.warn("No se pudo obtener datos de Discord, continuando sin ellos..."),console.log("Response status:",r.status);else{const o=await r.json();console.log("Datos de Discord obtenidos:",o);const{error:t}=await n.auth.updateUser({data:{...a.user.user_metadata,discord_id:o.id,discord_username:o.username,discord_avatar:o.avatar?`https://cdn.discordapp.com/avatars/${o.id}/${o.avatar}.png`:null,discord_connected:!0,avatar_url:o.avatar?`https://cdn.discordapp.com/avatars/${o.id}/${o.avatar}.png`:null}});t?console.error("Error al actualizar metadatos:",t):console.log("Metadatos actualizados correctamente")}}catch(r){console.warn("Error obteniendo datos de Discord:",r)}console.log("Redirigiendo a la página principal..."),window.location.href="/"}catch(e){console.error("Error en callback:",e);const s=e instanceof Error?e.message:"Error desconocido";alert("Error al conectar con Discord: "+s),window.location.href="/"}};c();
